<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto-scroll Akordy - BPM Synchronizace</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Calibri', Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            min-height: 100vh;
            overflow: hidden;
        }

        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .controls {
            background: rgba(30, 30, 30, 0.95);
            padding: 15px 20px;
            border-bottom: 2px solid #444;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .control-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        label {
            font-weight: bold;
            font-size: 0.9em;
            white-space: nowrap;
        }

        input[type="number"], select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #555;
            font-size: 0.95em;
            width: 80px;
            background: #2a2a2a;
            color: #fff;
        }

        select {
            width: 120px;
        }

        #songSelector {
            width: 250px;
            max-width: 250px;
        }

        input[type="file"] {
            display: none;
        }

        button {
            padding: 10px 24px;
            font-size: 0.95em;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            color: white;
        }

        button:hover {
            transform: translateY(-1px);
            filter: brightness(1.2);
        }

        #playBtn {
            background: #28a745;
        }

        #pauseBtn {
            background: #ffc107;
        }

        #resetBtn {
            background: #17a2b8;
        }

        #uploadBtn {
            background: #6f42c1;
            margin-left: auto;
        }

        .status {
            padding: 8px 16px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
            font-size: 0.9em;
        }

        .status.playing {
            background: rgba(40, 167, 69, 0.3);
        }

        .status.paused {
            background: rgba(255, 193, 7, 0.3);
        }

        .status.loading {
            background: rgba(111, 66, 193, 0.3);
        }

        /* Skryt√≠ ovl√°dac√≠ch prvk≈Ø */
        .controls-hidden .control-item:not(.always-visible),
        .controls-hidden #fullscreenBtn,
        .controls-hidden #uploadBtn,
        .controls-hidden .status,
        .controls-hidden .file-info {
            display: none !important;
        }

        /* Men≈°√≠ li≈°ta kdy≈æ jsou ovl√°dac√≠ prvky skryt√© */
        .controls-hidden {
            padding: 5px 10px !important;
            gap: 5px !important;
        }

        /* Tlaƒç√≠tko pro zobrazen√≠ ovl√°d√°n√≠ - v≈ædy viditeln√© */
        #showControlsBtn {
            display: none;
            background: #28a745;
            padding: 8px 16px;
        }

        .controls-hidden #showControlsBtn {
            display: inline-block !important;
        }

        .controls-hidden #hideControlsBtn {
            display: none !important;
        }

        #displayArea {
            flex: 1;
            background: #fff;
            color: #000;
            padding: 5px 10px;
            overflow-y: auto;
            scroll-behavior: smooth;
            column-gap: 15px;
        }

        /* Zachov√°n√≠ p≈ôesn√©ho form√°tov√°n√≠ z Wordu */
        #displayArea.loaded p {
            line-height: 1.08; /* P≈ôesn√Ω line-height jako Word (default je cca 1.08 = single spacing) */
        }


        /* Zoom - pou≈æit√≠ font-size m√≠sto transform scale */
        #displayArea {
            font-size: 11pt; /* V√Ωchoz√≠ velikost p√≠sma */
            transition: font-size 0.2s ease;
        }

        /* Scrollbar */
        #displayArea::-webkit-scrollbar {
            width: 14px;
        }

        #displayArea::-webkit-scrollbar-track {
            background: #e0e0e0;
        }

        #displayArea::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 7px;
        }

        #displayArea::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .welcome-message {
            text-align: center;
            padding: 100px 20px;
            color: #999;
            font-family: 'Calibri', Arial, sans-serif;
        }

        .welcome-message h2 {
            margin-bottom: 20px;
        }

        .file-info {
            background: rgba(111, 66, 193, 0.2);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85em;
        }

        .song-separator {
            display: none; /* Skryjeme oddƒõlovaƒçe, zobraz√≠me jen vybranou skladbu */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <div class="control-item">
                <label for="songSelector">Skladba:</label>
                <select id="songSelector" style="display: none;">
                    <option value="">-- Vyberte skladbu --</option>
                </select>
            </div>

            <div class="control-item">
                <label for="bpmInput">BPM:</label>
                <input type="number" id="bpmInput" value="120" min="10" max="240" step="1">
            </div>

            <div class="control-item">
                <label for="speedMultiplier">Rychlost:</label>
                <select id="speedMultiplier">
                    <option value="0.1">0.1x (velmi pomal√©)</option>
                    <option value="0.2">0.2x</option>
                    <option value="0.3">0.3x</option>
                    <option value="0.5">0.5x</option>
                    <option value="0.75">0.75x</option>
                    <option value="1" selected>1x (norm√°ln√≠)</option>
                    <option value="1.25">1.25x</option>
                    <option value="1.5">1.5x</option>
                    <option value="2">2x (rychl√©)</option>
                </select>
            </div>

            <div class="control-item">
                <label for="scrollAmount">Px/beat:</label>
                <input type="number" id="scrollAmount" value="1" min="0.1" max="10" step="0.1">
            </div>

            <div class="control-item always-visible" style="display: flex; gap: 10px;">
                <button id="playBtn">‚ñ∂ PLAY</button>
                <button id="pauseBtn">‚è∏ PAUSE</button>
                <button id="resetBtn">‚èÆ RESET</button>
            </div>

            <div class="control-item">
                <label>Transpozice:</label>
                <button id="transposeDownBtn" style="background: #6c757d; padding: 8px 16px;">‚ô≠ -1</button>
                <span id="transposeLevel" style="min-width: 50px; text-align: center;">0</span>
                <button id="transposeUpBtn" style="background: #6c757d; padding: 8px 16px;">‚ôØ +1</button>
                <button id="transposeResetBtn" style="background: #6c757d; padding: 8px 12px;">‚ü≤</button>
            </div>

            <div class="control-item">
                <label for="columnCount">Sloupce:</label>
                <select id="columnCount">
                    <option value="1" selected>1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                </select>
            </div>

            <div class="control-item">
                <label>Velikost:</label>
                <button id="zoomOutBtn" style="background: #6c757d; padding: 8px 16px;">‚ûñ</button>
                <span id="zoomLevel" style="min-width: 50px; text-align: center;">100%</span>
                <button id="zoomInBtn" style="background: #6c757d; padding: 8px 16px;">‚ûï</button>
            </div>

            <div class="control-item">
                <label>Lupa:</label>
                <button id="scaleOutBtn" style="background: #6c757d; padding: 8px 16px;">‚ûñ</button>
                <span id="scaleLevel" style="min-width: 50px; text-align: center;">100%</span>
                <button id="scaleInBtn" style="background: #6c757d; padding: 8px 16px;">‚ûï</button>
            </div>

            <button id="fullscreenBtn" style="background: #fd7e14;">‚õ∂ Fullscreen</button>
            <button id="hideControlsBtn" style="background: #6c757d;">üëÅ Skr√Ωt ovl√°d√°n√≠</button>
            <button id="showControlsBtn">üëÅ Zobrazit ovl√°d√°n√≠</button>

            <div class="control-item">
                <label for="rotateSelect">Otoƒçen√≠:</label>
                <select id="rotateSelect">
                    <option value="0" selected>Ne</option>
                    <option value="90">90¬∞</option>
                </select>
            </div>

            <div class="control-item">
                <label for="fileSelector">Soubor:</label>
                <select id="fileSelector" style="display: none; width: 200px;">
                    <option value="">-- Vyberte soubor --</option>
                </select>
                <button id="deleteFileBtn" style="background: #dc3545; padding: 8px 16px; display: none;">üóë Smazat</button>
            </div>

            <div class="status" id="status">P≈ôipraveno</div>
            <div class="file-info" id="fileInfo" style="display: none;"></div>

            <input type="file" id="fileInput" accept=".docx,.doc">
            <button id="uploadBtn">üìÅ Nahr√°t DOCX soubor</button>
        </div>

        <div id="displayArea">
            <div class="welcome-message">
                <h2>üé∏ Nahr√°n√≠ Word dokumentu s akordy</h2>
                <p style="margin-top: 20px;">Kliknƒõte na "üìÅ Nahr√°t DOCX soubor" a vyberte v√°≈° dokument</p>
                <p style="margin-top: 10px;">V≈°echny skladby budou automaticky rozdƒõleny a lze mezi nimi p≈ôep√≠nat!</p>
            </div>
        </div>
    </div>

    <!-- Pot≈ôebn√© knihovny -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

    <script>
        let scrollInterval = null;
        let isPlaying = false;
        let allSongs = [];
        let currentSongIndex = 0;
        let zoomLevel = 100;
        let scaleLevel = 100; // Klasick√Ω zoom (transform scale)
        let transposeLevel = 0; // Aktu√°ln√≠ transpozice v p≈Øltonech
        let columnCount = 1; // Poƒçet sloupc≈Ø
        let rotateAngle = 0; // √öhel otoƒçen√≠
        let savedFiles = {}; // Ulo≈æen√© soubory
        let currentFileId = null; // ID aktu√°lnƒõ zobrazen√©ho souboru
        let scrollAccumulator = 0; // Akumul√°tor pro drobn√© scrolly
        let controlsHidden = false; // Stav skryt√≠ ovl√°d√°n√≠

        const displayArea = document.getElementById('displayArea');
        const bpmInput = document.getElementById('bpmInput');
        const speedMultiplier = document.getElementById('speedMultiplier');
        const scrollAmount = document.getElementById('scrollAmount');
        const playBtn = document.getElementById('playBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resetBtn = document.getElementById('resetBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('fileInput');
        const status = document.getElementById('status');
        const fileInfo = document.getElementById('fileInfo');
        const songSelector = document.getElementById('songSelector');
        const fileSelector = document.getElementById('fileSelector');
        const deleteFileBtn = document.getElementById('deleteFileBtn');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const zoomLevelSpan = document.getElementById('zoomLevel');
        const scaleInBtn = document.getElementById('scaleInBtn');
        const scaleOutBtn = document.getElementById('scaleOutBtn');
        const scaleLevelSpan = document.getElementById('scaleLevel');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const transposeUpBtn = document.getElementById('transposeUpBtn');
        const transposeDownBtn = document.getElementById('transposeDownBtn');
        const transposeResetBtn = document.getElementById('transposeResetBtn');
        const transposeLevelSpan = document.getElementById('transposeLevel');
        const columnCountSelect = document.getElementById('columnCount');
        const rotateSelect = document.getElementById('rotateSelect');
        const hideControlsBtn = document.getElementById('hideControlsBtn');
        const showControlsBtn = document.getElementById('showControlsBtn');

        // Skr√Ωt ovl√°d√°n√≠
        hideControlsBtn.addEventListener('click', () => {
            const controls = document.querySelector('.controls');
            controlsHidden = true;
            controls.classList.add('controls-hidden');
        });

        // Zobrazit ovl√°d√°n√≠
        showControlsBtn.addEventListener('click', () => {
            const controls = document.querySelector('.controls');
            controlsHidden = false;
            controls.classList.remove('controls-hidden');
        });

        // Kl√°vesov√° zkratka H pro skryt√≠/zobrazen√≠ ovl√°d√°n√≠
        document.addEventListener('keydown', (e) => {
            if (e.code === 'KeyH' && !['INPUT', 'SELECT'].includes(e.target.tagName)) {
                e.preventDefault();
                if (controlsHidden) {
                    showControlsBtn.click();
                } else {
                    hideControlsBtn.click();
                }
            }
        });

        // Naƒç√≠st ulo≈æen√© soubory z localStorage p≈ôi startu
        function loadSavedFiles() {
            const saved = localStorage.getItem('savedDocxFiles');
            if (saved) {
                try {
                    savedFiles = JSON.parse(saved);
                    updateFileSelector();

                    // Naƒç√≠st posledn√≠ pou≈æit√Ω soubor
                    const lastFileId = localStorage.getItem('lastFileId');
                    if (lastFileId && savedFiles[lastFileId]) {
                        fileSelector.value = lastFileId;
                        loadFileFromStorage(lastFileId);
                    }
                } catch (e) {
                    console.error('Chyba p≈ôi naƒç√≠t√°n√≠ ulo≈æen√Ωch soubor≈Ø:', e);
                }
            }
        }

        // Aktualizovat file selector
        function updateFileSelector() {
            fileSelector.innerHTML = '<option value="">-- Vyberte soubor --</option>';

            for (const [id, fileData] of Object.entries(savedFiles)) {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = fileData.name;
                fileSelector.appendChild(option);
            }

            if (Object.keys(savedFiles).length > 0) {
                fileSelector.style.display = 'inline-block';
                deleteFileBtn.style.display = 'inline-block';
            } else {
                fileSelector.style.display = 'none';
                deleteFileBtn.style.display = 'none';
            }
        }

        // Naƒç√≠st soubor z localStorage
        function loadFileFromStorage(fileId) {
            const fileData = savedFiles[fileId];
            if (!fileData) return;

            currentFileId = fileId;
            localStorage.setItem('lastFileId', fileId);

            // Naƒç√≠st skladby
            allSongs = fileData.songs;
            currentSongIndex = 0;

            // Naplnit song selector
            songSelector.innerHTML = '<option value="">-- Vyberte skladbu --</option>';
            allSongs.forEach((song, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${index + 1}. ${song.title}`;
                songSelector.appendChild(option);
            });

            songSelector.style.display = 'block';

            // Zobrazit prvn√≠ skladbu
            if (allSongs.length > 0) {
                songSelector.value = '0';
                displaySong(0);
            }

            status.textContent = `‚úì Naƒçteno ${allSongs.length} skladeb`;
            fileInfo.style.display = 'block';
            fileInfo.textContent = `üìÑ ${fileData.name}`;
        }

        // Upload tlaƒç√≠tko otev≈ôe file dialog
        uploadBtn.addEventListener('click', () => {
            fileInput.click();
        });

        // Zmƒõna vybran√©ho souboru
        fileSelector.addEventListener('change', (e) => {
            const fileId = e.target.value;
            if (fileId) {
                loadFileFromStorage(fileId);
            }
        });

        // Smazat aktu√°ln√≠ soubor
        deleteFileBtn.addEventListener('click', () => {
            if (!currentFileId) {
                alert('Nejprve vyberte soubor ke smaz√°n√≠');
                return;
            }

            const fileName = savedFiles[currentFileId].name;
            if (confirm(`Opravdu chcete smazat soubor "${fileName}"?`)) {
                delete savedFiles[currentFileId];
                localStorage.setItem('savedDocxFiles', JSON.stringify(savedFiles));

                if (currentFileId === localStorage.getItem('lastFileId')) {
                    localStorage.removeItem('lastFileId');
                }

                currentFileId = null;
                allSongs = [];
                displayArea.innerHTML = '<div class="welcome-message"><h2>üé∏ Nahr√°n√≠ Word dokumentu s akordy</h2><p style="margin-top: 20px;">Kliknƒõte na "üìÅ Nahr√°t DOCX soubor" a vyberte v√°≈° dokument</p><p style="margin-top: 10px;">V≈°echny skladby budou automaticky rozdƒõleny a lze mezi nimi p≈ôep√≠nat!</p></div>';
                songSelector.style.display = 'none';

                updateFileSelector();
                status.textContent = 'Soubor smaz√°n';
            }
        });

        // Zoom In
        zoomInBtn.addEventListener('click', () => {
            zoomLevel = Math.min(zoomLevel + 10, 200);
            applyZoom();
        });

        // Zoom Out
        zoomOutBtn.addEventListener('click', () => {
            zoomLevel = Math.max(zoomLevel - 10, 50);
            applyZoom();
        });

        // Aplikovat zoom pomoc√≠ font-size
        function applyZoom() {
            // V√Ωchoz√≠ velikost je 11pt, ≈°k√°lujeme podle zoom level
            const baseFontSize = 11; // pt
            const fontSize = (baseFontSize * zoomLevel) / 100;
            displayArea.style.fontSize = `${fontSize}pt`;
            zoomLevelSpan.textContent = `${zoomLevel}%`;
        }

        // Scale In (klasick√Ω zoom)
        scaleInBtn.addEventListener('click', () => {
            scaleLevel = Math.min(scaleLevel + 10, 200);
            applyScale();
        });

        // Scale Out (klasick√Ω zoom)
        scaleOutBtn.addEventListener('click', () => {
            scaleLevel = Math.max(scaleLevel - 10, 50);
            applyScale();
        });

        // Aplikovat klasick√Ω zoom pomoc√≠ transform scale
        function applyScale() {
            const scale = scaleLevel / 100;
            displayArea.style.transform = `scale(${scale})`;
            displayArea.style.transformOrigin = 'top left';
            displayArea.style.width = `${100 / scale}%`;
            displayArea.style.height = `${100 / scale}%`;
            scaleLevelSpan.textContent = `${scaleLevel}%`;
        }

        // Fullscreen
        fullscreenBtn.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                fullscreenBtn.textContent = '‚úï Exit Fullscreen';
            } else {
                document.exitFullscreen();
                fullscreenBtn.textContent = '‚õ∂ Fullscreen';
            }
        });

        // Listener pro fullscreen zmƒõny
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                fullscreenBtn.textContent = '‚õ∂ Fullscreen';
            }
        });

        // Zmƒõna skladby
        songSelector.addEventListener('change', (e) => {
            const songIndex = parseInt(e.target.value);
            if (!isNaN(songIndex)) {
                currentSongIndex = songIndex;
                displaySong(songIndex);
            }
        });

        // Transpozice akord≈Ø
        transposeUpBtn.addEventListener('click', () => {
            transposeLevel++;
            applyTranspose();
        });

        transposeDownBtn.addEventListener('click', () => {
            transposeLevel--;
            applyTranspose();
        });

        transposeResetBtn.addEventListener('click', () => {
            transposeLevel = 0;
            applyTranspose();
        });

        // Zmƒõna poƒçtu sloupc≈Ø
        columnCountSelect.addEventListener('change', (e) => {
            columnCount = parseInt(e.target.value);
            applyColumns();
        });

        // Aplikovat sloupcov√© zobrazen√≠
        function applyColumns() {
            if (columnCount > 1) {
                displayArea.style.columnCount = columnCount;
                displayArea.style.columnFill = 'auto';
            } else {
                displayArea.style.columnCount = '1';
                displayArea.style.columnFill = 'balance';
            }
        }

        // Otoƒçen√≠ obrazovky
        rotateSelect.addEventListener('change', (e) => {
            rotateAngle = parseInt(e.target.value);
            applyRotation();
        });

        // Aplikovat otoƒçen√≠
        function applyRotation() {
            const container = document.querySelector('.container');

            if (rotateAngle === 0) {
                container.style.transform = 'none';
                container.style.transformOrigin = 'center';
                container.style.width = '100%';
                container.style.height = '100vh';
                container.style.position = 'relative';
                container.style.top = 'auto';
                container.style.left = 'auto';
                container.style.marginLeft = '0';
                container.style.marginTop = '0';
            } else if (rotateAngle === 90) {
                container.style.transform = 'rotate(90deg)';
                container.style.transformOrigin = 'center center';
                container.style.width = '100vh';
                container.style.height = '100vw';
                container.style.position = 'absolute';
                container.style.top = '50%';
                container.style.left = '50%';
                container.style.marginLeft = '-50vh';
                container.style.marginTop = '-50vw';
            }
        }

        // Kdy≈æ u≈æivatel vybere soubor
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            status.textContent = '‚è≥ Naƒç√≠t√°m soubor...';
            status.className = 'status loading';
            fileInfo.style.display = 'block';
            fileInfo.textContent = `üìÑ ${file.name}`;

            try {
                const arrayBuffer = await file.arrayBuffer();
                await parseDocxToHtml(arrayBuffer);

                // Ulo≈æit soubor do localStorage
                const fileId = Date.now().toString();
                currentFileId = fileId;

                savedFiles[fileId] = {
                    name: file.name,
                    songs: allSongs,
                    uploadedAt: new Date().toISOString()
                };

                localStorage.setItem('savedDocxFiles', JSON.stringify(savedFiles));
                localStorage.setItem('lastFileId', fileId);

                updateFileSelector();
                fileSelector.value = fileId;

                status.textContent = `‚úì Naƒçteno ${allSongs.length} skladeb - soubor ulo≈æen`;
                status.className = 'status';

            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ souboru:', error);
                status.textContent = '‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ souboru';
                status.className = 'status';
                alert('Nepoda≈ôilo se naƒç√≠st soubor. Ujistƒõte se, ≈æe je to platn√Ω DOCX soubor.');
            }
        });

        // Zobrazen√≠ konkr√©tn√≠ skladby
        function displaySong(index) {
            if (index < 0 || index >= allSongs.length) return;

            const song = allSongs[index];
            displayArea.innerHTML = song.html;
            displayArea.classList.add('loaded');

            // Nastavit BPM pokud je v textu skladby
            const bpmMatch = song.text.match(/BPM[:\s]*(\d+)/i);
            if (bpmMatch) {
                bpmInput.value = bpmMatch[1];
            }

            resetBtn.click();
            status.textContent = `üìù ${song.title}`;
        }

        // Vlastn√≠ parser DOCX - p≈ô√≠mo ƒçte XML a p≈ôev√°d√≠ na HTML se zachov√°n√≠m V≈†ECH styl≈Ø
        async function parseDocxToHtml(arrayBuffer) {
            const zip = await JSZip.loadAsync(arrayBuffer);
            const documentXml = await zip.file('word/document.xml').async('string');

            // Parse XML
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(documentXml, 'text/xml');

            // Zpracovat v≈°echny paragrafy
            const paragraphs = xmlDoc.querySelectorAll('w\\:p, p');

            let currentSongHtml = '';
            let currentSongText = '';
            let currentSongTitle = '';
            let emptyLineCount = 0;
            let hasContent = false;

            paragraphs.forEach((paragraph, index) => {
                const paragraphResult = parseParagraph(paragraph);
                const isEmpty = !paragraphResult.text.trim();
                const text = paragraphResult.text.trim();

                // Detekce n√°zvu p√≠sniƒçky ve form√°tu "KAPELA - P√çSE≈á"
                // Mus√≠ b√Ωt VELK√ùMI P√çSMENY, obsahovat pomlƒçku, nesm√≠ obsahovat vyk≈ôiƒçn√≠ky
                // Podporuje r≈Øzn√© typy pomlƒçek: - (hyphen), ‚Äì (en-dash), ‚Äî (em-dash)
                const hasUppercase = text === text.toUpperCase() && /[A-Z√Åƒåƒé√âƒö√ç≈á√ì≈ò≈†≈§√ö≈Æ√ù≈Ω]/.test(text);
                const hasDash = /[-‚Äì‚Äî]/.test(text);
                const hasExclamation = /!/.test(text);
                const hasProperFormat = /^[^-‚Äì‚Äî!]+[\s]*[-‚Äì‚Äî][\s]*[^-‚Äì‚Äî!]+$/.test(text); // Slovo - Slovo (bez vyk≈ôiƒçn√≠k≈Ø)
                const isSongTitle = hasUppercase && hasDash && !hasExclamation && hasProperFormat && text.length > 5;

                if (!isEmpty && isSongTitle) {
                    // Na≈°li jsme nov√Ω n√°zev skladby - ulo≈æit p≈ôedchoz√≠ skladbu
                    if (hasContent && currentSongHtml.trim()) {
                        allSongs.push({
                            title: currentSongTitle || `Skladba ${allSongs.length + 1}`,
                            html: currentSongHtml,
                            text: currentSongText
                        });
                    }

                    // Reset pro novou skladbu
                    currentSongHtml = paragraphResult.html;
                    currentSongText = paragraphResult.text + '\n';
                    currentSongTitle = text;
                    hasContent = true;
                    emptyLineCount = 0;
                } else {
                    // Nen√≠ to n√°zev - p≈ôidat k aktu√°ln√≠ skladbƒõ
                    if (isEmpty) {
                        emptyLineCount++;
                    } else {
                        emptyLineCount = 0;
                        hasContent = true;
                    }

                    currentSongHtml += paragraphResult.html;
                    currentSongText += paragraphResult.text + '\n';
                }
            });

            // Ulo≈æit posledn√≠ skladbu
            if (currentSongHtml.trim()) {
                allSongs.push({
                    title: currentSongTitle || `Skladba ${allSongs.length + 1}`,
                    html: currentSongHtml,
                    text: currentSongText
                });
            }

            // Naplnit selector
            songSelector.innerHTML = '<option value="">-- Vyberte skladbu --</option>';
            allSongs.forEach((song, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${index + 1}. ${song.title}`;
                songSelector.appendChild(option);
            });

            songSelector.style.display = 'block';

            // Zobrazit prvn√≠ skladbu
            if (allSongs.length > 0) {
                currentSongIndex = 0;
                songSelector.value = '0';
                displaySong(0);
            }
        }

        // Parsov√°n√≠ jednotliv√©ho paragrafu
        function parseParagraph(paragraph) {
            let paragraphText = '';

            // Zpracovat spacing (mezery p≈ôed/po odstavci) z Word XML
            const pPr = paragraph.querySelector('w\\:pPr, pPr');
            let spacingBefore = 0;
            let spacingAfter = 0;
            let lineSpacing = null;

            if (pPr) {
                const spacing = pPr.querySelector('w\\:spacing, spacing');
                if (spacing) {
                    // Before spacing (mezera p≈ôed odstavcem)
                    const before = spacing.getAttribute('w:before') || spacing.getAttribute('before');
                    if (before) spacingBefore = parseInt(before) / 20; // P≈ôevod z TWIPs na body

                    // After spacing (mezera za odstavcem)
                    const after = spacing.getAttribute('w:after') || spacing.getAttribute('after');
                    if (after) spacingAfter = parseInt(after) / 20;

                    // Line spacing (≈ô√°dkov√°n√≠)
                    const line = spacing.getAttribute('w:line') || spacing.getAttribute('line');
                    const lineRule = spacing.getAttribute('w:lineRule') || spacing.getAttribute('lineRule');
                    if (line) {
                        if (lineRule === 'auto') {
                            // Automatick√© ≈ô√°dkov√°n√≠ (nap≈ô. 1.0, 1.5, 2.0)
                            lineSpacing = parseInt(line) / 240; // 240 = single spacing
                        } else {
                            // P≈ôesn√© ≈ô√°dkov√°n√≠ v TWIPs
                            lineSpacing = `${parseInt(line) / 20}pt`;
                        }
                    }
                }
            }

            // Vytvo≈ôit inline styly pro paragraf
            let pStyle = 'margin: 0; padding: 0;';

            // Pokud nen√≠ spacing definov√°n, pou≈æij Word default (200 TWIPs = 10pt)
            let finalSpacingAfter = 10; // default
            if (spacingAfter > 0) {
                finalSpacingAfter = spacingAfter;
            }

            if (spacingBefore > 0) pStyle += ` margin-top: ${spacingBefore}pt;`;
            pStyle += ` margin-bottom: ${finalSpacingAfter}pt;`;

            if (lineSpacing !== null) {
                if (typeof lineSpacing === 'number') {
                    pStyle += ` line-height: ${lineSpacing};`;
                } else {
                    pStyle += ` line-height: ${lineSpacing};`;
                }
            } else {
                // Word default line spacing = 1.15
                pStyle += ` line-height: 1.15;`;
            }

            let paragraphHtml = `<p style="${pStyle}">`;

            // Zpracovat v≈°echny text runs v paragrafu
            const runs = paragraph.querySelectorAll('w\\:r, r');

            runs.forEach(run => {
                const rPr = run.querySelector('w\\:rPr, rPr');
                const textNode = run.querySelector('w\\:t, t');

                if (textNode) {
                    let text = textNode.textContent;
                    paragraphText += text;
                    let styles = '';

                    if (rPr) {
                        // Barva
                        const color = rPr.querySelector('w\\:color, color');
                        if (color) {
                            const colorVal = color.getAttribute('w:val') || color.getAttribute('val');
                            if (colorVal && colorVal !== 'auto') {
                                styles += `color: #${colorVal}; `;
                            }
                        }

                        // Velikost p√≠sma - pou≈æ√≠t em pro ≈°k√°lovatelnost
                        const sz = rPr.querySelector('w\\:sz, sz');
                        if (sz) {
                            const sizeVal = sz.getAttribute('w:val') || sz.getAttribute('val');
                            if (sizeVal) {
                                const fontSizePt = parseInt(sizeVal) / 2;
                                // P≈ôev√©st na em relativnƒõ k base size 11pt
                                const fontSizeEm = fontSizePt / 11;
                                styles += `font-size: ${fontSizeEm}em; `;
                            }
                        }

                        // Tuƒçn√©
                        const b = rPr.querySelector('w\\:b, b');
                        if (b) {
                            styles += 'font-weight: bold; ';
                        }

                        // Kurz√≠va
                        const i = rPr.querySelector('w\\:i, i');
                        if (i) {
                            styles += 'font-style: italic; ';
                        }

                        // Podtr≈æen√≠
                        const u = rPr.querySelector('w\\:u, u');
                        if (u) {
                            styles += 'text-decoration: underline; ';
                        }

                        // Font
                        const rFonts = rPr.querySelector('w\\:rFonts, rFonts');
                        if (rFonts) {
                            const fontName = rFonts.getAttribute('w:ascii') || rFonts.getAttribute('ascii');
                            if (fontName) {
                                styles += `font-family: '${fontName}', Arial, sans-serif; `;
                            }
                        }
                    }

                    if (styles) {
                        paragraphHtml += `<span style="${styles}">${escapeHtml(text)}</span>`;
                    } else {
                        paragraphHtml += escapeHtml(text);
                    }
                }

                // Tabul√°tory
                const tab = run.querySelector('w\\:tab, tab');
                if (tab) {
                    paragraphHtml += '&nbsp;&nbsp;&nbsp;&nbsp;';
                    paragraphText += '    ';
                }
            });

            // Pokud je paragraf pr√°zdn√Ω, p≈ôidej nbsp aby mƒõl v√Ω≈°ku (jako ve Wordu)
            if (paragraphText.trim() === '') {
                paragraphHtml += '&nbsp;';
            }

            paragraphHtml += '</p>';

            return {
                html: paragraphHtml,
                text: paragraphText
            };
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // V√Ωpoƒçet rychlosti scrollov√°n√≠
        function calculateScrollSpeed() {
            const bpm = parseInt(bpmInput.value) || 120;
            const multiplier = parseFloat(speedMultiplier.value) || 1;
            const pixels = parseFloat(scrollAmount.value) || 1;

            // V√Ωpoƒçet scrollov√°n√≠:
            // BPM = kolik beat≈Ø za minutu
            // "pixels" parametr = kolik pixel≈Ø posunout za beat
            // P≈ôid√°me konstantu 10x pro praktick√© pou≈æit√≠
            const intervalMs = 50;
            const pixelsPerBeat = pixels * 10; // Zvƒõt≈°eno 10x
            const beatsPerSecond = bpm / 60;
            const pixelsPerSecond = beatsPerSecond * pixelsPerBeat * multiplier;
            const scrollPixels = (pixelsPerSecond * intervalMs) / 1000;

            return { intervalMs, scrollPixels };
        }

        // Play
        playBtn.addEventListener('click', () => {
            if (isPlaying) return;

            if (displayArea.querySelector('.welcome-message')) {
                alert('Nejd≈ô√≠v nahrajte DOCX soubor!');
                return;
            }

            isPlaying = true;
            status.textContent = '‚ñ∂ P≈ôehr√°v√° se...';
            status.className = 'status playing';
            scrollAccumulator = 0; // Reset akumul√°toru

            const { intervalMs, scrollPixels } = calculateScrollSpeed();

            scrollInterval = setInterval(() => {
                // Akumulujeme drobn√© scrolly a scrollujeme a≈æ kdy≈æ m√°me alespo≈à 1 pixel
                scrollAccumulator += scrollPixels;

                if (scrollAccumulator >= 1) {
                    const pixelsToScroll = Math.floor(scrollAccumulator);
                    displayArea.scrollTop += pixelsToScroll;
                    scrollAccumulator -= pixelsToScroll;
                }

                if (displayArea.scrollTop >= displayArea.scrollHeight - displayArea.clientHeight - 10) {
                    pause();
                    status.textContent = '‚úì Konec';
                }
            }, intervalMs);
        });

        // Pause
        function pause() {
            if (scrollInterval) {
                clearInterval(scrollInterval);
                scrollInterval = null;
            }
            isPlaying = false;
            scrollAccumulator = 0; // Reset akumul√°toru p≈ôi pauze
            status.textContent = '‚è∏ Pozastaveno';
            status.className = 'status paused';
        }

        pauseBtn.addEventListener('click', pause);

        // Reset
        resetBtn.addEventListener('click', () => {
            pause();
            displayArea.scrollTop = 0;
            status.textContent = 'P≈ôipraveno';
            status.className = 'status';
        });

        // Dynamick√° zmƒõna rychlosti
        [bpmInput, speedMultiplier, scrollAmount].forEach(element => {
            element.addEventListener('change', () => {
                if (isPlaying) {
                    pause();
                    setTimeout(() => playBtn.click(), 100);
                }
            });
        });

        // Transpozice akord≈Ø
        const chordMap = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'H'];
        const chordAliases = {
            'B': 'A#',  // Nƒõkdy se pou≈æ√≠v√° B m√≠sto A#
            'Db': 'C#', 'Eb': 'D#', 'Gb': 'F#', 'Ab': 'G#', 'Bb': 'A#', 'Hb': 'A#'
        };

        function isValidChord(text) {
            // Kontrola, zda je to platn√Ω akord (zaƒç√≠n√° A-H, m≈Ø≈æe m√≠t #/b a pak modifik√°tory)
            // Platn√© p≈ô√≠klady: C, C#, Cm, Cmi, C7, Cmaj7, Dsus4, G#m7, Ami, atd.
            const chordPattern = /^[A-H][b#]?(mi|maj|min|sus|dim|aug|add|m)?\d*$/;
            return chordPattern.test(text);
        }

        function transposeChord(chord, semitones) {
            if (!chord || chord.trim() === '') return chord;

            // Pokud to nen√≠ platn√Ω akord, vr√°tit p≈Øvodn√≠ text
            if (!isValidChord(chord)) return chord;

            // Naj√≠t akord v textu - m≈Ø≈æe b√Ωt C, C#, Cm, C7, Cmaj7, atd.
            const chordRegex = /^([A-H][b#]?)(.*)$/;
            const match = chord.match(chordRegex);

            if (!match) return chord;

            let root = match[1];  // C, C#, D, atd.
            const suffix = match[2]; // m, 7, maj7, atd.

            // P≈ôev√©st aliasy (nap≈ô. Db -> C#)
            if (chordAliases[root]) {
                root = chordAliases[root];
            }

            // Naj√≠t pozici v mapƒõ
            let index = chordMap.indexOf(root);
            if (index === -1) return chord;

            // Aplikovat transpozici
            index = (index + semitones) % 12;
            if (index < 0) index += 12;

            return chordMap[index] + suffix;
        }

        function applyTranspose() {
            if (!allSongs[currentSongIndex]) return;

            // Aktualizovat zobrazen√≠ √∫rovnƒõ transpozice
            transposeLevelSpan.textContent = transposeLevel > 0 ? `+${transposeLevel}` : transposeLevel;

            // Znovu zobrazit skladbu s novou transpozic√≠
            const song = allSongs[currentSongIndex];
            displayArea.innerHTML = song.html;
            displayArea.classList.add('loaded');

            // Naj√≠t v≈°echny akordy a transponovat je
            if (transposeLevel !== 0) {
                // Naj√≠t v≈°echny span elementy s modrou barvou (akordy z Wordu)
                const allSpans = displayArea.querySelectorAll('span[style*="color"]');

                allSpans.forEach(span => {
                    const style = span.getAttribute('style');
                    // Zkontrolovat jestli je to modr√° barva (akordy)
                    if (style && (style.includes('color: #0070c0') || style.includes('color: #0000ff') || style.includes('color: #'))) {
                        // Transponovat ka≈æd√Ω akord uvnit≈ô spanu samostatnƒõ, zachovat mezery a ƒç√°rky
                        const originalText = span.textContent;

                        // Rozdƒõlit text na tokeny (akordy, mezery, ƒç√°rky, atd.)
                        const tokens = originalText.split(/(\s+|,)/);

                        const transposedTokens = tokens.map(token => {
                            // Pokud je to mezera nebo ƒç√°rka, zachovat
                            if (/^\s+$/.test(token) || token === ',') {
                                return token;
                            }
                            // Jinak to m≈Ø≈æe b√Ωt akord - zkusit transponovat
                            const trimmed = token.trim();
                            if (trimmed.length > 0) {
                                return transposeChord(trimmed, transposeLevel);
                            }
                            return token;
                        });

                        span.textContent = transposedTokens.join('');
                    }
                });
            }

            resetBtn.click();
        }

        // Kl√°vesov√© zkratky
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;

            if (e.code === 'Space') {
                e.preventDefault();
                if (isPlaying) {
                    pause();
                } else {
                    playBtn.click();
                }
            } else if (e.code === 'Escape') {
                e.preventDefault();
                resetBtn.click();
            } else if (e.code === 'KeyO' && e.ctrlKey) {
                e.preventDefault();
                uploadBtn.click();
            } else if (e.code === 'ArrowRight') {
                // Dal≈°√≠ skladba
                e.preventDefault();
                if (currentSongIndex < allSongs.length - 1) {
                    songSelector.value = currentSongIndex + 1;
                    songSelector.dispatchEvent(new Event('change'));
                }
            } else if (e.code === 'ArrowLeft') {
                // P≈ôedchoz√≠ skladba
                e.preventDefault();
                if (currentSongIndex > 0) {
                    songSelector.value = currentSongIndex - 1;
                    songSelector.dispatchEvent(new Event('change'));
                }
            } else if (e.code === 'Equal' && e.ctrlKey) {
                // Ctrl + = pro zoom in
                e.preventDefault();
                zoomInBtn.click();
            } else if (e.code === 'Minus' && e.ctrlKey) {
                // Ctrl + - pro zoom out
                e.preventDefault();
                zoomOutBtn.click();
            } else if (e.code === 'Digit0' && e.ctrlKey) {
                // Ctrl + 0 pro reset zoom
                e.preventDefault();
                zoomLevel = 100;
                applyZoom();
            } else if (e.code === 'KeyF' && e.ctrlKey) {
                // Ctrl + F pro fullscreen
                e.preventDefault();
                fullscreenBtn.click();
            }
        });

        // Drag & Drop
        displayArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            displayArea.style.background = '#f0f0f0';
        });

        displayArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            displayArea.style.background = '#fff';
        });

        displayArea.addEventListener('drop', async (e) => {
            e.preventDefault();
            displayArea.style.background = '#fff';

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files;
                    fileInput.dispatchEvent(new Event('change'));
                } else {
                    alert('Pros√≠m nahrajte DOCX nebo DOC soubor!');
                }
            }
        });

        // Naƒç√≠st ulo≈æen√© soubory p≈ôi startu
        loadSavedFiles();
    </script>
</body>
</html>
